<style>
    :root {
        --bot-theme-color: #2d6a4f;
        --bot-theme-light: #b7e4c7;
        --bot-white: rgba(255, 255, 255, 0.9);
    }

    /* Floating Button */
    #chatbot-fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        background: var(--bot-theme-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #chatbot-fab:hover {
        transform: scale(1.1);
    }

    #chatbot-fab.pulse {
        animation: botPulse 2s infinite;
    }

    @keyframes botPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(45, 106, 79, 0.7);
        }

        70% {
            box-shadow: 0 0 0 15px rgba(45, 106, 79, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(45, 106, 79, 0);
        }
    }

    /* Chat Window */
    #chatbot-window {
        position: fixed;
        bottom: 100px;
        right: 25px;
        width: 380px;
        max-width: calc(100vw - 50px);
        height: 550px;
        max-height: calc(100vh - 150px);
        background: var(--bot-white);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        display: none;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        overflow: hidden;
        animation: botSlideUp 0.4s ease-out;
    }

    @keyframes botSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Header */
    #chatbot-header {
        background: var(--bot-theme-color);
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    #chatbot-header .bot-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #chatbot-header .status-dot {
        width: 8px;
        height: 8px;
        background: #00ff00;
        border-radius: 50%;
        display: inline-block;
    }

    /* Messages Area */
    #chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(240, 245, 240, 0.5);
    }

    .bot-msg {
        max-width: 85%;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 14px;
        line-height: 1.4;
        animation: botFadeIn 0.3s ease-out;
    }

    @keyframes botFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .bot-msg.user {
        align-self: flex-end;
        background: var(--bot-theme-color);
        color: white;
        border-bottom-right-radius: 2px;
    }

    .bot-msg.ai {
        align-self: flex-start;
        background: white;
        color: #333;
        border-bottom-left-radius: 2px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    /* Input Area */
    #chatbot-input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
    }

    #chatbot-input-area input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 25px;
        padding: 8px 15px;
        outline: none;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    #chatbot-input-area input:focus {
        border-color: var(--bot-theme-color);
    }

    #chatbot-send-btn {
        background: var(--bot-theme-color);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    #chatbot-send-btn:hover {
        background: #1b4332;
    }

    /* Mobile Optimization */
    @media (max-width: 768px) {
        #chatbot-window {
            bottom: 85px;
            right: 15px;
            width: calc(100vw - 30px);
            height: calc(100vh - 120px);
            max-height: 500px;
        }

        #chatbot-fab {
            bottom: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
    }
</style>

<!-- FAB -->
<div id="chatbot-fab" onclick="toggleBotWindow()" class="pulse">
    ü§ñ
</div>

<!-- Window -->
<div id="chatbot-window">
    <div id="chatbot-header">
        <div class="bot-info">
            <span style="font-size: 20px;">üöú</span>
            <div>
                <div style="font-weight: 600; font-size: 14px;">Agri Assistant</div>
                <div style="font-size: 11px; opacity: 0.8;"><span class="status-dot"></span> Online</div>
            </div>
        </div>
        <div onclick="toggleBotWindow()" style="cursor: pointer; font-size: 18px;">&times;</div>
    </div>

    <div id="chatbot-messages">
        <div class="bot-msg ai">
            Hello! I'm your Smart Agriculture assistant. How can I help you today? üå±
        </div>
        {% if chatbot_crop %}
        <div class="bot-msg ai" style="font-size: 12px; background: rgba(255,255,255,0.6);">
            Currently assisting with: <b>{{ chatbot_crop|title }}</b>
            {% if chatbot_stage %} <br> Stage: <b>{{ chatbot_stage }}</b> {% endif %}
        </div>
        {% endif %}
    </div>

    <div id="chatbot-input-area">
        <input type="text" id="botQuery" placeholder="Ask something..."
            onkeypress="if(event.key==='Enter') sendBotMessage()">
        <button id="chatbot-send-btn" onclick="sendBotMessage()">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
        </button>
    </div>
</div>

<script>
    function toggleBotWindow() {
        const win = document.getElementById('chatbot-window');
        const fab = document.getElementById('chatbot-fab');
        if (win.style.display === 'none' || win.style.display === '') {
            win.style.display = 'flex';
            fab.classList.remove('pulse');
        } else {
            win.style.display = 'none';
        }
    }

    function sendBotMessage() {
        const input = document.getElementById('botQuery');
        const msg = input.value.trim();
        if (!msg) return;

        const container = document.getElementById('chatbot-messages');

        // Add User Message
        const userDiv = document.createElement('div');
        userDiv.className = 'bot-msg user';
        userDiv.textContent = msg;
        container.appendChild(userDiv);

        input.value = '';
        container.scrollTop = container.scrollHeight;

        // Context (Standardized variables from Django views)
        const crop = "{{ chatbot_crop|default:'' }}";
        const stage = "{{ chatbot_stage|default:'' }}";
        const stage_id = "{{ chatbot_stage_id|default:'' }}";

        fetch("/chatbot/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `message=${encodeURIComponent(msg)}&crop=${encodeURIComponent(crop)}&stage=${encodeURIComponent(stage)}&stage_id=${encodeURIComponent(stage_id)}`
        })
            .then(res => res.json())
            .then(data => {
                const aiDiv = document.createElement('div');
                aiDiv.className = 'bot-msg ai';
                aiDiv.innerHTML = data.reply.replace(/\n/g, "<br>");
                container.appendChild(aiDiv);
                container.scrollTop = container.scrollHeight;
            })
            .catch(err => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bot-msg ai';
                errorDiv.style.color = 'red';
                errorDiv.textContent = "‚ö†Ô∏è Sorry, I encountered an error. Please try again.";
                container.appendChild(errorDiv);
            });
    }
</script>